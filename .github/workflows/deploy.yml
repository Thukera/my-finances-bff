name: ðŸš€ Deploy Backend to Orange Pi

on:
  push:
    branches:
      - master  # Only deploy on master branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¦ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Install cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared
      
      - name: ðŸ” Setup SSH with Cloudflare Access
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_SERVICE_TOKEN_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_SERVICE_TOKEN_SECRET }}
          SSH_PRIVATE_KEY: ${{ secrets.ORANGE_PI_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # Configure SSH to use cloudflared
          cat >> ~/.ssh/config <<EOF
		  Host ssh.hardman.app.br
		    User thukera
		    IdentityFile ~/.ssh/id_ed25519
		    ProxyCommand cloudflared access tcp --hostname %h --service-token-id $CF_ACCESS_CLIENT_ID --service-token-secret $CF_ACCESS_CLIENT_SECRET
		  EOF
      
      - name: ðŸš€ Deploy Backend
        run: |
          ssh ssh.hardman.app.br << 'ENDSSH'
            
             set -e  # Exit on any error
            
            echo "================================================"
            echo "ðŸš€ Starting Backend Deployment"
            echo "================================================"
            
            # Navigate to project directory
            cd ~/Projects/MyFinances/backend || exit 1
            
            # Create backup directory if it doesn't exist
            mkdir -p backups
            
            # Backup current JAR file (if exists)
            if [ -f "target/my-finances-bff.jar" ]; then
              BACKUP_DATE=$(date +"%d%m")
              BACKUP_FILE="backups/my-finances-bff-${BACKUP_DATE}.bkp"
              echo "ðŸ’¾ Backing up current JAR to ${BACKUP_FILE}..."
              cp target/my-finances-bff.jar "${BACKUP_FILE}"
              echo "âœ… Backup created: ${BACKUP_FILE}"
            else
              echo "â„¹ï¸  No existing JAR file to backup"
            fi
            
            # Pull latest code
            echo "ðŸ“¥ Pulling latest code from GitHub..."
            git fetch --all
            git reset --hard origin/master
            
            # Build Java application
            echo "ðŸ—ï¸  Building JAR file..."
            ./mvnw clean package -DskipTests
            
            # Build Docker image
            echo "ðŸ³ Building Docker image..."
            sudo docker build -t myfinances-backend:latest .
            
            # Stop old container
            echo "ðŸ›‘ Stopping old container..."
            sudo docker stop myfinances-bff || true
            sudo docker rm myfinances-bff || true
            
            # Run new container
            echo "â–¶ï¸  Starting new container..."
            sudo docker run -d \
              -p 9090:9090 \
              --name myfinances-bff \
              --restart unless-stopped \
              -v ~/Projects/MyFinances/backend/uploads:/app/uploads \
              -v ~/Projects/MyFinances/backend/logs:/app/logs \
              myfinances-backend:latest
            
            # Wait for container to start
            echo "â³ Waiting for container to start..."
            sleep 5
            
            # Verify container is running
            if sudo docker ps | grep -q myfinances-bff; then
              echo "âœ… Container is running!"
            else
              echo "âŒ Container failed to start!"
              sudo docker logs myfinances-bff
              exit 1
            fi
            
            # Clean up old images
            echo "ðŸ§¹ Cleaning up old Docker images..."
            sudo docker image prune -f
            
            # Show container status
            echo "ðŸ“Š Container Status:"
            sudo docker ps -a | grep myfinances-bff
            
            # List recent backups
            echo "ðŸ“¦ Recent Backups:"
            ls -lht backups/ | head -5
            
            echo "================================================"
            echo "âœ… Backend Deployment Complete!"
            echo "ðŸŒ API: https://api.hardman.app.br"
            echo "================================================"
            
          ENDSSH
      
      - name: ðŸ“¢ Notify on Success
        if: success()
        run: echo "âœ… Backend deployed successfully to Orange Pi!"
      
      - name: ðŸ“¢ Notify on Failure
        if: failure()
        run: echo "âŒ Backend deployment failed! Check logs above."