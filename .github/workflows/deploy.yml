name: ğŸš€ Deploy Backend to Orange Pi

on:
  push:
    branches:
      - master

concurrency:
  group: production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted  # â† Changed from ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸš€ Deploy Backend
        run: |
          set -e
          
          echo "================================================"
          echo "ğŸš€ Starting Backend Deployment"
          echo "================================================"
 
          
          # Build JAR
          echo "ğŸ—ï¸  Building JAR..."
          mvn clean package -DskipTests
          
          # Build Docker image
          echo "=== FILES AFTER BUILD ==="
          ls -la
          ls -la target
          echo "ğŸ³ Building Docker image..."
          docker build -t myfinances-backend:latest .
          
          # Stop old container
          echo "ğŸ›‘ Stopping old container..."
          docker stop myfinances-bff || true
          docker rm myfinances-bff || true
          
          # Run new container
          echo "â–¶ï¸  Starting new container..."
          docker run -d \
            -p 9090:9090 \
            --name myfinances-bff \
            --env-file /home/thukera/.env.myfinances \
            --restart unless-stopped \
            -v ~/Projects/MyFinances/backend/uploads:/app/uploads \
            -v ~/Projects/MyFinances/backend/logs:/app/logs \
            myfinances-backend:latest
          
          # Wait and verify
          sleep 5
          
          if docker ps | grep -q myfinances-bff; then
            echo "âœ… Container is running!"
          else
            echo "âŒ Container failed!"
            docker logs myfinances-bff
            exit 1
          fi
          
          # Cleanup
          docker image prune -f
          
          echo "================================================"
          echo "âœ… Backend Deployment Complete!"
          echo "ğŸŒ API: https://api.hardman.app.br"
          echo "================================================"