name: ğŸš€ Deploy Backend to Orange Pi

on:
  push:
    branches:
      #- master
      - cicd

jobs:
  deploy:
    runs-on: self-hosted  # â† Changed from ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸš€ Deploy Backend
        run: |
          set -e
          
          echo "================================================"
          echo "ğŸš€ Starting Backend Deployment"
          echo "================================================"
          
          # Create backup directory
          mkdir -p backups
          
          # Backup current JAR
          if [ -f "target/my-finances-bff-1.0.jar" ]; then
            BACKUP_DATE=$(date +"%d%m")
            BACKUP_FILE="backups/my-finances-bff-${BACKUP_DATE}.bkp"
            echo "ğŸ’¾ Backing up JAR to ${BACKUP_FILE}..."
            cp target/my-finances-bff-1.0.jar "${BACKUP_FILE}"
            echo "âœ… Backup created"
          fi
          
          # Build JAR
          echo "ğŸ—ï¸  Building JAR..."
          mvn clean package -DskipTests
          
          # Build Docker image
          echo "ğŸ³ Building Docker image..."
          sudo docker build -t myfinances-backend:latest .
          
          # Stop old container
          echo "ğŸ›‘ Stopping old container..."
          sudo docker stop myfinances-bff || true
          sudo docker rm myfinances-bff || true
          
          # Run new container
          echo "â–¶ï¸  Starting new container..."
          sudo docker run -d \
            -p 9090:9090 \
            --name myfinances-bff \
            --restart unless-stopped \
            -v ~/Projects/MyFinances/backend/uploads:/app/uploads \
            -v ~/Projects/MyFinances/backend/logs:/app/logs \
            myfinances-backend:latest
          
          # Wait and verify
          sleep 5
          
          if sudo docker ps | grep -q myfinances-bff; then
            echo "âœ… Container is running!"
          else
            echo "âŒ Container failed!"
            sudo docker logs myfinances-bff
            exit 1
          fi
          
          # Cleanup
          sudo docker image prune -f
          
          echo "================================================"
          echo "âœ… Backend Deployment Complete!"
          echo "ğŸŒ API: https://api.hardman.app.br"
          echo "================================================"