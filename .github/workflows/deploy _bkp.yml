name: ğŸš€ Deploy Backend to Orange Pi

on:
  push:
    branches:
      - master  # Only deploy on master branch

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ” Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORANGE_PI_HOST }}
          username: ${{ secrets.ORANGE_PI_USER }}
          key: ${{ secrets.ORANGE_PI_SSH_KEY }}
          port: 22
          script: |
            set -e  # Exit on any error
            
            echo "================================================"
            echo "ğŸš€ Starting Backend Deployment"
            echo "================================================"
            
            # Navigate to project directory
            cd ~/Projects/MyFinances/backend || exit 1
            
            # Create backup directory if it doesn't exist
            mkdir -p backups
            
            # Backup current JAR file (if exists)
            if [ -f "target/my-finances-bff.jar" ]; then
              BACKUP_DATE=$(date +"%d%m")
              BACKUP_FILE="backups/my-finances-bff-${BACKUP_DATE}.bkp"
              echo "ğŸ’¾ Backing up current JAR to ${BACKUP_FILE}..."
              cp target/my-finances-bff.jar "${BACKUP_FILE}"
              echo "âœ… Backup created: ${BACKUP_FILE}"
            else
              echo "â„¹ï¸  No existing JAR file to backup"
            fi
            
            # Pull latest code
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git fetch --all
            git reset --hard origin/master
            
            # Build Java application
            echo "ğŸ—ï¸  Building JAR file..."
            ./mvnw clean package -DskipTests
            
            # Build Docker image
            echo "ğŸ³ Building Docker image..."
            sudo docker build -t myfinances-backend:latest .
            
            # Stop old container
            echo "ğŸ›‘ Stopping old container..."
            sudo docker stop myfinances-bff || true
            sudo docker rm myfinances-bff || true
            
            # Run new container
            echo "â–¶ï¸  Starting new container..."
            sudo docker run -d \
              -p 9090:9090 \
              --name myfinances-bff \
              --restart unless-stopped \
              -v ~/Projects/MyFinances/backend/uploads:/app/uploads \
              -v ~/Projects/MyFinances/backend/logs:/app/logs \
              myfinances-backend:latest
            
            # Wait for container to start
            echo "â³ Waiting for container to start..."
            sleep 5
            
            # Verify container is running
            if sudo docker ps | grep -q myfinances-bff; then
              echo "âœ… Container is running!"
            else
              echo "âŒ Container failed to start!"
              sudo docker logs myfinances-bff
              exit 1
            fi
            
            # Clean up old images
            echo "ğŸ§¹ Cleaning up old Docker images..."
            sudo docker image prune -f
            
            # Show container status
            echo "ğŸ“Š Container Status:"
            sudo docker ps -a | grep myfinances-bff
            
            # List recent backups
            echo "ğŸ“¦ Recent Backups:"
            ls -lht backups/ | head -5
            
            echo "================================================"
            echo "âœ… Backend Deployment Complete!"
            echo "ğŸŒ API: https://api.hardman.app.br"
            echo "================================================"
      
      - name: ğŸ“¢ Notify on Success
        if: success()
        run: echo "âœ… Backend deployed successfully to Orange Pi!"
      
      - name: ğŸ“¢ Notify on Failure
        if: failure()
        run: echo "âŒ Backend deployment failed! Check logs above."